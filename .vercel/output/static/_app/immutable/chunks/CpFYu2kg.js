import{w as J}from"./BJF9mgOB.js";function B(S,N){return{createEffect:(c,m,o)=>{const d=Date.now(),g=["#ff6b6b","#4ecdc4","#45b7d1","#f9ca24","#6c5ce7","#a29bfe"],A=Math.floor(Math.random()*g.length),p={reverb:{roomSize:.7,dampening:.5,wet:.5,dry:.5},delay:{time:.25,feedback:.5,wet:.5,dry:.5},filter:{type:"lowpass",frequency:.5,resonance:.5},distortion:{amount:.3,drive:.5},compressor:{threshold:.7,ratio:4,attack:.01,release:.1},chorus:{rate:.5,depth:.6,delay:.02,wet:.5}};return{id:crypto.randomUUID(),projectId:c,name:m,type:o,settings:p[o]||{},color:g[A],createdAt:d,updatedAt:d}},addEffect:c=>{S(m=>m?(Array.isArray(m.effects)||(m.effects=[]),{...m,effects:[...m.effects,c]}):(console.warn("Cannot add effect: no project exists"),m))},updateEffect:(c,m)=>{S(o=>o&&{...o,effects:(o.effects||[]).map(d=>d.id===c?{...d,...m,updatedAt:Date.now()}:d)})},deleteEffect:c=>{S(m=>m&&{...m,effects:(m.effects||[]).filter(o=>o.id!==c)})}}}function R(S,N){return{createEnvelope:(c,m,o)=>{const d=Date.now(),g=["#ff6b6b","#4ecdc4","#45b7d1","#f9ca24","#6c5ce7","#a29bfe"],A=Math.floor(Math.random()*g.length),p={volume:{attack:.01,decay:.1,sustain:.7,release:.2},filter:{attack:.01,decay:.1,sustain:.5,release:.2,cutoffStart:.2,cutoffEnd:.8},pitch:{attack:.01,decay:.1,sustain:0,release:.2,pitchStart:0,pitchEnd:12},pan:{attack:.01,decay:.1,sustain:.5,release:.2,panStart:-.5,panEnd:.5}};return{id:crypto.randomUUID(),projectId:c,name:m,type:o,settings:p[o]||{},color:g[A],createdAt:d,updatedAt:d}},addEnvelope:c=>{S(m=>m?(Array.isArray(m.envelopes)||(m.envelopes=[]),{...m,envelopes:[...m.envelopes,c]}):(console.warn("Cannot add envelope: no project exists"),m))},updateEnvelope:(c,m)=>{S(o=>o&&{...o,envelopes:(o.envelopes||[]).map(d=>d.id===c?{...d,...m,updatedAt:Date.now()}:d)})},deleteEnvelope:c=>{S(m=>m&&{...m,envelopes:(m.envelopes||[]).filter(o=>o.id!==c)})}}}function z(S,N){return{getAutomationId:(c,m,o,d)=>d?`${c}:${m}:${d}:${o}`:`${c}:${m}:${o}`,getParameterAutomation:(c,m,o,d)=>{const g=N();if(!g||!g.automation)return null;const A=d?`${c}:${m}:${d}:${o}`:`${c}:${m}:${o}`;return g.automation[A]||null},setParameterAutomation:(c,m)=>{S(o=>{if(!o)return o;const d=m||c.timelineInstanceId?`${c.targetType}:${c.targetId}:${m||c.timelineInstanceId}:${c.parameterKey}`:`${c.targetType}:${c.targetId}:${c.parameterKey}`,g=o.automation||{};return{...o,automation:{...g,[d]:{...c,timelineInstanceId:m||c.timelineInstanceId}}}})},deleteParameterAutomation:(c,m,o,d)=>{S(g=>{if(!g||!g.automation)return g;const A=d?`${c}:${m}:${d}:${o}`:`${c}:${m}:${o}`,p=g.automation,{[A]:k,...D}=p;return{...g,automation:D}})},updateAutomationPoint:(c,m,o,d,g,A)=>{S(p=>{var C;if(!p)return p;const k=A?`${c}:${m}:${A}:${o}`:`${c}:${m}:${o}`,D=(C=p.automation)==null?void 0:C[k];if(!D)return p;const P=[...D.points];P[d]={...P[d],...g};const x=p.automation||{};return{...p,automation:{...x,[k]:{...D,points:P}}}})},addAutomationPoint:(c,m,o,d,g)=>{S(A=>{var x,C,h;if(!A)return A;const p=g?`${c}:${m}:${g}:${o}`:`${c}:${m}:${o}`,k=(x=A.automation)==null?void 0:x[p];if(!k){(C=A.effects)==null||C.find(r=>r.id===m),(h=A.envelopes)==null||h.find(r=>r.id===m);const n=0,t=1,e=A.automation||{};return{...A,automation:{...e,[p]:{targetType:c,targetId:m,parameterKey:o,timelineInstanceId:g,points:[d],min:n,max:t}}}}const D=[...k.points,d].sort((n,t)=>n.beat-t.beat),P=A.automation||{};return{...A,automation:{...P,[p]:{...k,points:D}}}})},removeAutomationPoint:(c,m,o,d,g)=>{S(A=>{var x;if(!A)return A;const p=g?`${c}:${m}:${g}:${o}`:`${c}:${m}:${o}`,k=(x=A.automation)==null?void 0:x[p];if(!k)return A;const D=k.points.filter((C,h)=>h!==d),P=A.automation||{};return{...A,automation:{...P,[p]:{...k,points:D}}}})}}}function X(){const{subscribe:S,set:N,update:c}=J(null),m=50;let o=[],d=-1,g=!1,A=!1,p=null;const{subscribe:k,set:D}=J({canUndo:!1,canRedo:!1}),P=()=>{const n=o.length>=2&&d>0,t=d<o.length-1;D({canUndo:n,canRedo:t})},x=n=>n?JSON.parse(JSON.stringify(n)):null,C=()=>{let n=null;return S(t=>n=t)(),n},h=(n,t=!1)=>{if(g){c(n);return}if(t){c(n);return}let e=null;if(S(s=>e=s)(),A){if(!p&&e){const s=x(e);s&&s.id&&(p=s,o=o.slice(0,d+1),o.push(s),d++,o.length>m&&(o.shift(),d--),P())}c(n);return}if(e){const s=e;Array.isArray(s.standaloneInstruments)||(s.standaloneInstruments=[]),Array.isArray(s.effects)||(s.effects=[]),Array.isArray(s.envelopes)||(s.envelopes=[]),o=o.slice(0,d+1);const i=x(e);i&&i.id?(Array.isArray(i.standaloneInstruments)||(i.standaloneInstruments=[]),o.push(i),d++,o.length>m&&(o.shift(),d--),P()):console.warn("Failed to clone project for history",e)}else console.warn("Cannot save to history: invalid project",e);let r=null;c(s=>(r=n(s),r)),r&&Array.isArray(r.standaloneInstruments)&&x(r)};return{subscribe:S,subscribeHistory:k,getCurrent:C,startBatch:()=>{A||(A=!0,p=null)},endBatch:()=>{if(A){A=!1;let n=null;if(S(t=>n=t)(),n){const t=n;Array.isArray(t.standaloneInstruments)||(t.standaloneInstruments=[]),Array.isArray(t.effects)||(t.effects=[]),Array.isArray(t.envelopes)||(t.envelopes=[]),o=o.slice(0,d+1);const e=x(n);e&&e.id&&(Array.isArray(e.standaloneInstruments)||(e.standaloneInstruments=[]),o.push(e),d++,o.length>m&&(o.shift(),d--),P())}p=null}},set:n=>{if(!g&&n&&n.id&&o.length===0){Array.isArray(n.standaloneInstruments)||(n.standaloneInstruments=[]);const t=x(n);t&&t.id&&(Array.isArray(t.standaloneInstruments)||(t.standaloneInstruments=[]),o.push(t),d=0,P())}N(n)},update:h,undo:()=>{if(o.length===0||d<=0||o.length<2)return!1;g=!0,d--;const n=o[d];if(!n||!n.id||!Array.isArray(n.standaloneInstruments)){let t=!1;for(let e=d;e>=0;e--){const r=o[e];if(r&&r.id&&Array.isArray(r.standaloneInstruments)){d=e;const s=x(r);if(s){N(s),t=!0;break}}}if(!t)return d++,g=!1,P(),!1}else{const t=x(n);if(t&&t.id&&Array.isArray(t.standaloneInstruments))N(t);else return d++,g=!1,P(),!1}return g=!1,P(),!0},redo:()=>{if(o.length===0||d>=o.length-1)return!1;g=!0,d++;const n=o[d];if(!n||!n.id||!Array.isArray(n.standaloneInstruments)){let t=!1;for(let e=d;e<o.length;e++){const r=o[e];if(r&&r.id&&Array.isArray(r.standaloneInstruments)){d=e;const s=x(r);if(s){N(s),t=!0;break}}}if(!t)return d--,g=!1,P(),!1}else{const t=x(n);if(t&&t.id&&Array.isArray(t.standaloneInstruments))N(t);else return d--,g=!1,P(),!1}return g=!1,P(),!0},canUndo:()=>o.length>1&&d>0,canRedo:()=>d<o.length-1,createNewStandaloneInstrument:(n,t="kick")=>{const e=400+Math.random()*200,r=200+Math.random()*100,s={id:crypto.randomUUID(),division:4,x:e,y:r,children:[]},i=200,a=e-i*1.5,u=r+200;for(let I=0;I<4;I++){const f=a+I*i,v={id:crypto.randomUUID(),division:1,x:f,y:u,children:[],velocity:1,pitch:60},$=40,U=f-$*1.5,b=u+150;for(let T=0;T<4;T++){const w=U+T*$;v.children.push({id:crypto.randomUUID(),division:1,x:w,y:b,children:[],velocity:v.velocity!==void 0?v.velocity:1,pitch:v.pitch!==void 0?v.pitch:60})}s.children.push(v)}const l={kick:{color:"#00ffff",settings:{attack:.005,decay:.4,sustain:0,release:.15}},snare:{color:"#ff00ff",settings:{attack:.005,decay:.2,sustain:0,release:.1}},hihat:{color:"#ffff00",settings:{attack:.001,decay:.05,sustain:0,release:.01}},clap:{color:"#ff6600",settings:{attack:.001,decay:.1,sustain:0,release:.05}},tom:{color:"#00ff00",settings:{attack:.01,decay:.4,sustain:0,release:.1}},cymbal:{color:"#ff0066",settings:{attack:.01,decay:.5,sustain:0,release:.2}},shaker:{color:"#6600ff",settings:{attack:.01,decay:.3,sustain:0,release:.1}},rimshot:{color:"#ff9900",settings:{attack:.001,decay:.08,sustain:0,release:.05}},subtractive:{color:"#00ffcc",settings:{attack:.1,decay:.2,sustain:.7,release:.3,osc1Type:"saw",osc2Type:"saw",osc2Detune:0,filterCutoff:5e3,filterResonance:.5}},fm:{color:"#cc00ff",settings:{attack:.1,decay:.2,sustain:.7,release:.3,operators:[{frequency:1,amplitude:1,waveform:"sine"}]}},wavetable:{color:"#ffcc00",settings:{attack:.1,decay:.2,sustain:.7,release:.3}},supersaw:{color:"#ff3366",settings:{attack:.1,decay:.2,sustain:.7,release:.3,numOscillators:7,detune:.1,spread:.5,filterCutoff:8e3,filterResonance:.5,lfoRate:0,lfoAmount:0}},pluck:{color:"#66ff99",settings:{attack:.01,decay:.3,sustain:0,release:.4,damping:.96}},bass:{color:"#0066ff",settings:{attack:.05,decay:.2,sustain:.8,release:.3,osc1Type:"saw",subLevel:.6,saturation:.3,filterCutoff:2e3,filterResonance:.3}}},y=l[t]||l.kick;return{id:crypto.randomUUID(),projectId:n,instrumentType:t,patternTree:s,settings:{...y.settings},volume:1,pan:0,color:y.color,mute:!1,solo:!1}},addStandaloneInstrument:n=>{h(t=>{if(!t)return console.warn("Cannot add standalone instrument: no project exists"),t;Array.isArray(t.standaloneInstruments)||(t.standaloneInstruments=[]);const e=t.standaloneInstruments.length===0,r={...t,standaloneInstruments:[...t.standaloneInstruments,n],baseMeterTrackId:e?n.id:t.baseMeterTrackId};return console.log("Adding standalone instrument:",{instrumentId:n.id,totalInstruments:r.standaloneInstruments.length}),r})},updateStandaloneInstrument:(n,t,e=!1)=>{h(r=>r&&{...r,standaloneInstruments:r.standaloneInstruments.map(s=>s.id===n?{...s,...t}:s)},e)},removeStandaloneInstrument:n=>{h(t=>{var r;if(!t)return t;let e=t.baseMeterTrackId;return e===n&&(e=(r=t.standaloneInstruments.filter(i=>i.id!==n)[0])==null?void 0:r.id),{...t,standaloneInstruments:t.standaloneInstruments.filter(s=>s.id!==n),baseMeterTrackId:e}})},setBaseMeterTrack:n=>{h(t=>{var e;return t&&{...t,baseMeterTrackId:n||((e=t.standaloneInstruments[0])==null?void 0:e.id)}})},copyStandaloneInstrument:n=>{h(t=>{if(!t)return t;const e=t.standaloneInstruments.find(f=>f.id===n);if(!e)return t;const r=t.standaloneInstruments.findIndex(f=>f.id===n),i=(f=>JSON.parse(JSON.stringify(f)))(e.patternTree),a=f=>({...f,id:crypto.randomUUID(),children:f.children.map(a)}),u=a(i);u.x=(e.patternTree.x??0)+300,u.y=(e.patternTree.y??0)+100;const l=f=>JSON.parse(JSON.stringify(f)),y={id:crypto.randomUUID(),projectId:e.projectId,instrumentType:e.instrumentType,patternTree:u,settings:l(e.settings||{}),instrumentSettings:e.instrumentSettings?Object.keys(e.instrumentSettings).reduce((f,v)=>(f[v]=l(e.instrumentSettings[v]),f),{}):void 0,volume:e.volume,pan:e.pan,color:e.color,mute:e.mute,solo:e.solo},I=[...t.standaloneInstruments];return I.splice(r+1,0,y),{...t,standaloneInstruments:I}})},addChildNode:(n,t,e=1)=>{h(r=>r&&{...r,standaloneInstruments:r.standaloneInstruments.map(s=>{if(s.id!==n)return s;const i=a=>{if(a.id===t){const u={id:crypto.randomUUID(),division:e,x:0,y:0,children:[],velocity:a.velocity!==void 0?a.velocity:1,pitch:a.pitch!==void 0?a.pitch:60},l=[...a.children,u],y=l.length,I=160,f=Math.PI/3,v=Math.PI/2,$=v-f/2,U=l.map((b,T)=>{let w;if(y===1)w=v;else{const L=T/(y-1);w=$+f*(1-L)}const M=(a.x||0)+Math.cos(w)*I,O=(a.y||0)+Math.sin(w)*I;if(b.id===u.id){const L=y>1?T/(y-1):0;console.log("[NodePositioning] New child node",{index:T,totalChildren:y,ratio:L.toFixed(3),angle:(w*180/Math.PI).toFixed(1)+"°",startAngle:($*180/Math.PI).toFixed(1)+"°",spreadAngle:(f*180/Math.PI).toFixed(1)+"°",formula:`startAngle(${($*180/Math.PI).toFixed(1)}°) + spreadAngle(${(f*180/Math.PI).toFixed(1)}°) * (1 - ratio(${L.toFixed(3)})) = ${(w*180/Math.PI).toFixed(1)}°`,x:M.toFixed(1),y:O.toFixed(1),radius:I})}return{...b,x:M,y:O}});return{...a,children:U}}return{...a,children:a.children.map(i)}};return{...s,patternTree:i(s.patternTree)}})})},deleteNode:(n,t)=>{h(e=>e&&{...e,standaloneInstruments:e.standaloneInstruments.map(r=>{if(r.id!==n)return r;const s=a=>a.id===t?null:{...a,children:a.children.map(s).filter(u=>u!==null)},i=s(r.patternTree);return i?{...r,patternTree:i}:r})})},updateNodeDivision:(n,t,e)=>{h(r=>r&&{...r,standaloneInstruments:r.standaloneInstruments.map(s=>{if(s.id!==n)return s;const i=a=>a.id===t?{...a,division:e}:{...a,children:a.children.map(i)};return{...s,patternTree:i(s.patternTree)}})})},updateNodePitch:(n,t,e)=>{h(r=>r&&{...r,standaloneInstruments:r.standaloneInstruments.map(s=>{if(s.id!==n)return s;const i=a=>{if(a.id===t){const u=l=>({...l,pitch:e,children:l.children.map(u)});return u(a)}return{...a,children:a.children.map(i)}};return{...s,patternTree:i(s.patternTree)}})})},updateNodeVelocity:(n,t,e)=>{h(r=>r&&{...r,standaloneInstruments:r.standaloneInstruments.map(s=>{if(s.id!==n)return s;const i=a=>{if(a.id===t){const u=l=>({...l,velocity:e,children:l.children.map(u)});return u(a)}return{...a,children:a.children.map(i)}};return{...s,patternTree:i(s.patternTree)}})})},addTimelineClip:n=>{h(t=>{if(!t)return t;const e=t.timeline||{tracks:[],clips:[],effects:[],envelopes:[],totalLength:16},r={...e,clips:[...e.clips||[],n],totalLength:Math.max(e.totalLength,n.startBeat+n.duration)};return{...t,timeline:r}})},updateTimelineClip:(n,t)=>{h(e=>{if(!e||!e.timeline)return e;const r={...e.timeline,clips:e.timeline.clips.map(s=>s.id===n?{...s,...t}:s),totalLength:e.timeline.totalLength};if(t.startBeat!==void 0||t.duration!==void 0){const s=Math.max(...r.clips.map(i=>i.startBeat+i.duration),r.totalLength);r.totalLength=s}return{...e,timeline:r}})},deleteTimelineClip:n=>{h(t=>{if(!t||!t.timeline)return t;const e={...t.timeline,clips:(t.timeline.clips||[]).filter(r=>r.id!==n)};return{...t,timeline:e}})},updateTimelineLength:n=>{h(t=>{if(!t)return t;const e=t.timeline||{tracks:[],clips:[],effects:[],envelopes:[],totalLength:16};return{...t,timeline:{...e,totalLength:Math.max(n,e.totalLength)}}})},addTimelineEffect:n=>{h(t=>{if(!t)return t;const e=t.timeline||{tracks:[],clips:[],effects:[],envelopes:[],totalLength:16},r={...e,effects:[...e.effects||[],n],totalLength:Math.max(e.totalLength,n.startBeat+n.duration)};return{...t,timeline:r}})},updateTimelineEffect:(n,t)=>{h(e=>{if(!e||!e.timeline)return e;const r={...e.timeline,effects:(e.timeline.effects||[]).map(s=>s.id===n?{...s,...t}:s),totalLength:e.timeline.totalLength};if(t.startBeat!==void 0||t.duration!==void 0){const s=Math.max(...(r.effects||[]).map(i=>i.startBeat+i.duration),r.totalLength);r.totalLength=s}return{...e,timeline:r}})},deleteTimelineEffect:n=>{h(t=>{if(!t||!t.timeline)return t;const e={...t.timeline,effects:(t.timeline.effects||[]).filter(r=>r.id!==n)};return{...t,timeline:e}})},addTimelineEnvelope:n=>{h(t=>{if(!t)return t;const e=t.timeline||{tracks:[],clips:[],effects:[],envelopes:[],totalLength:16},r={...e,envelopes:[...e.envelopes||[],n],totalLength:Math.max(e.totalLength,n.startBeat+n.duration)};return{...t,timeline:r}})},updateTimelineEnvelope:(n,t)=>{h(e=>{if(!e||!e.timeline)return e;const r={...e.timeline,envelopes:(e.timeline.envelopes||[]).map(s=>s.id===n?{...s,...t}:s),totalLength:e.timeline.totalLength};if(t.startBeat!==void 0||t.duration!==void 0){const s=Math.max(...(r.envelopes||[]).map(i=>i.startBeat+i.duration),r.totalLength);r.totalLength=s}return{...e,timeline:r}})},deleteTimelineEnvelope:n=>{h(t=>{if(!t||!t.timeline)return t;const e={...t.timeline,envelopes:(t.timeline.envelopes||[]).filter(r=>r.id!==n)};return{...t,timeline:e}})},createTimelineTrack:(n,t,e)=>{var y;const r=Date.now(),s={pattern:"Pattern Track",effect:"Effect Track",envelope:"Envelope Track"},i={pattern:"#7ab8ff",effect:"#9b59b6",envelope:"#2ecc71"},a=C(),u=((y=a==null?void 0:a.timeline)==null?void 0:y.tracks)||[];let l;if(n==="pattern"){const I=u.filter(f=>f.type==="pattern");I.length===0?l=0:l=Math.min(...I.map(v=>v.order))-1}else l=(u.length>0?Math.max(...u.map(f=>f.order)):999)+1;return{id:crypto.randomUUID(),type:n,name:e||`${s[n]} ${u.filter(I=>I.type===n).length+1}`,patternId:t,order:l,volume:1,mute:!1,solo:!1,color:i[n],createdAt:r}},addTimelineTrack:n=>{h(t=>{if(!t)return t;const e=t.timeline||{tracks:[],clips:[],effects:[],envelopes:[],totalLength:16},r={...e,tracks:[...e.tracks||[],n]};return{...t,timeline:r}})},deleteTimelineTrack:n=>{h(t=>{if(!t||!t.timeline)return t;const e={...t.timeline,tracks:(t.timeline.tracks||[]).filter(r=>r.id!==n),clips:(t.timeline.clips||[]).filter(r=>r.trackId!==n),effects:(t.timeline.effects||[]).filter(r=>r.trackId!==n),envelopes:(t.timeline.envelopes||[]).filter(r=>r.trackId!==n)};return{...t,timeline:e}})},updateTimelineTrack:(n,t)=>{h(e=>{if(!e||!e.timeline)return e;const r={...e.timeline,tracks:(e.timeline.tracks||[]).map(s=>s.id===n?{...s,...t}:s)};return{...e,timeline:r}})},normalizePattern:n=>{if(n.instruments&&Array.isArray(n.instruments)&&n.instruments.length>0)return n;if(n.instrumentType&&n.patternTree){const t={id:crypto.randomUUID(),instrumentType:n.instrumentType,patternTree:n.patternTree,settings:n.settings||{},instrumentSettings:n.instrumentSettings,color:n.color||"#7ab8ff",volume:n.volume??1,pan:n.pan??0,mute:n.mute,solo:n.solo};return{...n,instruments:[t],instrumentType:n.instrumentType,patternTree:n.patternTree,settings:n.settings,instrumentSettings:n.instrumentSettings,color:n.color,volume:n.volume,pan:n.pan}}return{...n,instruments:[]}},getPatternInstruments:n=>n.instruments&&Array.isArray(n.instruments)&&n.instruments.length>0?n.instruments:n.instrumentType&&n.patternTree?[{id:crypto.randomUUID(),instrumentType:n.instrumentType,patternTree:n.patternTree,settings:n.settings||{},instrumentSettings:n.instrumentSettings,color:n.color||"#7ab8ff",volume:n.volume??1,pan:n.pan??0,mute:n.mute,solo:n.solo}]:[],createPattern:(n,t,e,r)=>{const s=Date.now();return{id:crypto.randomUUID(),projectId:n,name:t,baseMeter:4,mute:!1,solo:!1,createdAt:s,updatedAt:s,instruments:[],instrumentType:"",patternTree:{id:crypto.randomUUID(),division:4,x:0,y:0,children:[]},settings:{},instrumentSettings:void 0,color:"#7ab8ff",volume:1,pan:0}},addPattern:n=>{h(t=>{if(!t)return console.warn("Cannot add pattern: no project exists"),t;Array.isArray(t.patterns)||(t.patterns=[]);const e=i=>({...i,children:i.children.map(a=>e(a))}),r=i=>i.map(a=>({...a,patternTree:e(a.patternTree),settings:{...a.settings},instrumentSettings:a.instrumentSettings?Object.keys(a.instrumentSettings).reduce((u,l)=>(u[l]={...a.instrumentSettings[l]},u),{}):void 0})),s={...n,instruments:n.instruments&&Array.isArray(n.instruments)?r(n.instruments):void 0,patternTree:n.patternTree?e(n.patternTree):void 0,settings:{...n.settings},instrumentSettings:n.instrumentSettings?Object.keys(n.instrumentSettings).reduce((i,a)=>(i[a]={...n.instrumentSettings[a]},i),{}):void 0};return{...t,patterns:[...t.patterns,s]}})},updatePattern:(n,t,e=!1)=>{h(r=>{if(!r)return r;const s=l=>({...l,children:l.children.map(y=>s(y))}),i=l=>l.map(y=>({...y,patternTree:s(y.patternTree),settings:{...y.settings},instrumentSettings:y.instrumentSettings?Object.keys(y.instrumentSettings).reduce((I,f)=>(I[f]={...y.instrumentSettings[f]},I),{}):void 0})),a={...t};t.patternTree&&(a.patternTree=s(t.patternTree)),t.instruments&&Array.isArray(t.instruments)&&(a.instruments=i(t.instruments)),t.settings&&(a.settings={...t.settings}),t.instrumentSettings&&(a.instrumentSettings=Object.keys(t.instrumentSettings).reduce((l,y)=>(l[y]={...t.instrumentSettings[y]},l),{}));const u=(r.patterns||[]).map(l=>l.id===n?{...l,...a,updatedAt:Date.now()}:l);return{...r,patterns:u}},e)},addPatternInstrument:(n,t)=>{h(e=>e&&{...e,patterns:(e.patterns||[]).map(r=>{if(r.id!==n)return r;const s=F.normalizePattern(r),i=[...s.instruments||[],t];return{...s,instruments:i,updatedAt:Date.now()}})})},removePatternInstrument:(n,t)=>{h(e=>e&&{...e,patterns:(e.patterns||[]).map(r=>{if(r.id!==n)return r;const s=F.normalizePattern(r),i=(s.instruments||[]).filter(a=>a.id!==t);return{...s,instruments:i,updatedAt:Date.now()}})})},updatePatternInstrument:(n,t,e,r=!1)=>{h(s=>s&&{...s,patterns:(s.patterns||[]).map(i=>{if(i.id!==n)return i;const a=F.normalizePattern(i),u=(a.instruments||[]).map(l=>l.id===t?{...l,...e}:l);return{...a,instruments:u,updatedAt:Date.now()}})},r)},copyPatternInstrument:(n,t)=>{h(e=>{if(!e)return e;const r=(e.patterns||[]).find(T=>T.id===n);if(!r)return e;const i=(r.instruments&&Array.isArray(r.instruments)&&r.instruments.length>0?r.instruments:r.instrumentType&&r.patternTree?[{id:r.id,instrumentType:r.instrumentType,patternTree:r.patternTree,settings:r.settings||{},instrumentSettings:r.instrumentSettings,color:r.color||"#7ab8ff",volume:r.volume??1,pan:r.pan??0,mute:r.mute,solo:r.solo}]:[]).find(T=>T.id===t);if(!i)return e;const a=T=>JSON.parse(JSON.stringify(T)),u=T=>({...T,id:crypto.randomUUID(),children:T.children.map(u)}),l=T=>JSON.parse(JSON.stringify(T)),y=a(i.patternTree),I=u(y),f=300,v=100,$=T=>({...T,x:(T.x??0)+f,y:(T.y??0)+v,children:T.children.map($)}),U=$(I),b={id:crypto.randomUUID(),instrumentType:i.instrumentType,patternTree:U,settings:l(i.settings||{}),instrumentSettings:i.instrumentSettings?Object.keys(i.instrumentSettings).reduce((T,w)=>(T[w]=l(i.instrumentSettings[w]),T),{}):void 0,color:i.color,volume:i.volume,pan:i.pan,mute:i.mute??!1,solo:i.solo??!1};return{...e,patterns:(e.patterns||[]).map(T=>{if(T.id!==n)return T;const w=F.normalizePattern(T),M=[...w.instruments||[],b];return{...w,instruments:M,updatedAt:Date.now()}})}})},copyPattern:n=>{h(t=>{var I;if(!t)return t;const e=(t.patterns||[]).find(f=>f.id===n);if(!e)return t;const r=e.instruments&&Array.isArray(e.instruments)&&e.instruments.length>0?e.instruments:e.instrumentType&&e.patternTree?[{id:e.id,instrumentType:e.instrumentType,patternTree:e.patternTree,settings:e.settings||{},instrumentSettings:e.instrumentSettings,color:e.color||"#7ab8ff",volume:e.volume??1,pan:e.pan??0,mute:e.mute,solo:e.solo}]:[],s=f=>JSON.parse(JSON.stringify(f)),i=f=>({...f,id:crypto.randomUUID(),children:f.children.map(i)}),a=f=>JSON.parse(JSON.stringify(f)),u=r.map((f,v)=>{const $=s(f.patternTree),U=i($);return U.x=(f.patternTree.x??0)+v*300,U.y=(f.patternTree.y??0)+v*100,{id:crypto.randomUUID(),projectId:e.projectId,instrumentType:f.instrumentType,patternTree:U,settings:a(f.settings||{}),instrumentSettings:f.instrumentSettings?Object.keys(f.instrumentSettings).reduce((b,T)=>(b[T]=a(f.instrumentSettings[T]),b),{}):void 0,volume:f.volume,pan:f.pan,color:f.color,mute:!1,solo:!1}});Array.isArray(t.standaloneInstruments)||(t.standaloneInstruments=[]);const l=[...t.standaloneInstruments,...u],y=t.standaloneInstruments.length===0;return{...t,standaloneInstruments:l,baseMeterTrackId:y?(I=u[0])==null?void 0:I.id:t.baseMeterTrackId}})},deletePattern:n=>{h(t=>{if(!t)return t;const e=t.timeline;return e&&(e.clips=(e.clips||[]).filter(r=>r.patternId!==n)),{...t,patterns:(t.patterns||[]).filter(r=>r.id!==n),timeline:e}})},getPattern:n=>{let t=null;return S(e=>t=e)(),t&&(t.patterns||[]).find(e=>e.id===n)||null},updatePatternTree:(n,t,e)=>{h(r=>r&&{...r,patterns:(r.patterns||[]).map(s=>{if(s.id!==n)return s;if(e&&s.instruments&&Array.isArray(s.instruments)){const i=s.instruments.map(a=>a.id===e?{...a,patternTree:t}:a);return{...s,instruments:i,updatedAt:Date.now()}}return{...s,patternTree:t,updatedAt:Date.now()}})})},updatePatternNodeDivision:(n,t,e,r)=>{h(s=>s&&{...s,patterns:(s.patterns||[]).map(i=>{if(i.id!==n)return i;const a=u=>u.id===t?{...u,division:e}:{...u,children:u.children.map(a)};if(r&&i.instruments&&Array.isArray(i.instruments)){const u=i.instruments.map(l=>l.id===r?{...l,patternTree:a(l.patternTree)}:l);return{...i,instruments:u,updatedAt:Date.now()}}return{...i,patternTree:a(i.patternTree||{id:crypto.randomUUID(),division:4,children:[]}),updatedAt:Date.now()}})})},updatePatternNodePitch:(n,t,e,r)=>{h(s=>s&&{...s,patterns:(s.patterns||[]).map(i=>{if(i.id!==n)return i;const a=u=>{if(u.id===t){const l=y=>({...y,pitch:e,children:y.children.map(l)});return l(u)}return{...u,children:u.children.map(a)}};if(r&&i.instruments&&Array.isArray(i.instruments)){const u=i.instruments.map(l=>l.id===r?{...l,patternTree:a(l.patternTree)}:l);return{...i,instruments:u,updatedAt:Date.now()}}return{...i,patternTree:a(i.patternTree||{id:crypto.randomUUID(),division:4,children:[]}),updatedAt:Date.now()}})})},updatePatternNodeVelocity:(n,t,e,r)=>{h(s=>s&&{...s,patterns:(s.patterns||[]).map(i=>{if(i.id!==n)return i;const a=u=>{if(u.id===t){const l=y=>({...y,velocity:e,children:y.children.map(l)});return l(u)}return{...u,children:u.children.map(a)}};if(r&&i.instruments&&Array.isArray(i.instruments)){const u=i.instruments.map(l=>l.id===r?{...l,patternTree:a(l.patternTree)}:l);return{...i,instruments:u,updatedAt:Date.now()}}return{...i,patternTree:a(i.patternTree||{id:crypto.randomUUID(),division:4,children:[]}),updatedAt:Date.now()}})})},addPatternChildNode:(n,t,e=1,r)=>{h(s=>s&&{...s,patterns:(s.patterns||[]).map(i=>{if(i.id!==n)return i;const a=u=>{if(u.id===t){const l={id:crypto.randomUUID(),division:e,x:0,y:0,children:[],velocity:u.velocity!==void 0?u.velocity:1,pitch:u.pitch!==void 0?u.pitch:60},y=[...u.children,l],I=y.length,f=160,v=Math.PI/3,$=Math.PI/2,U=$-v/2,b=y.map((T,w)=>{let M;if(I===1)M=$;else{const E=w/(I-1);M=U+v*(1-E)}const O=(u.x||0)+Math.cos(M)*f,L=(u.y||0)+Math.sin(M)*f;if(T.id===l.id){const E=I>1?w/(I-1):0;console.log("[NodePositioning] New child node",{index:w,totalChildren:I,ratio:E.toFixed(3),angle:(M*180/Math.PI).toFixed(1)+"°",startAngle:(U*180/Math.PI).toFixed(1)+"°",spreadAngle:(v*180/Math.PI).toFixed(1)+"°",formula:`startAngle(${(U*180/Math.PI).toFixed(1)}°) + spreadAngle(${(v*180/Math.PI).toFixed(1)}°) * (1 - ratio(${E.toFixed(3)})) = ${(M*180/Math.PI).toFixed(1)}°`,x:O.toFixed(1),y:L.toFixed(1),radius:f})}return{...T,x:O,y:L}});return{...u,children:b}}return{...u,children:u.children.map(a)}};if(r&&i.instruments&&Array.isArray(i.instruments)){const u=i.instruments.map(l=>l.id===r?{...l,patternTree:a(l.patternTree)}:l);return{...i,instruments:u,updatedAt:Date.now()}}return{...i,patternTree:a(i.patternTree||{id:crypto.randomUUID(),division:4,children:[]}),updatedAt:Date.now()}})})},deletePatternNode:(n,t,e)=>{h(r=>r&&{...r,patterns:(r.patterns||[]).map(s=>{if(s.id!==n)return s;const i=l=>l.id===t?null:{...l,children:l.children.map(i).filter(y=>y!==null)};if(e&&s.instruments&&Array.isArray(s.instruments)){const l=s.instruments.map(y=>{if(y.id!==e)return y;const I=i(y.patternTree);return I?{...y,patternTree:I}:{...y,patternTree:{id:crypto.randomUUID(),division:s.baseMeter||4,x:0,y:0,children:[]}}});return{...s,instruments:l,updatedAt:Date.now()}}const a=s.patternTree||{id:crypto.randomUUID(),division:4,children:[]},u=i(a);return u?{...s,patternTree:u,updatedAt:Date.now()}:{...s,patternTree:{id:crypto.randomUUID(),division:s.baseMeter||4,x:0,y:0,children:[]},updatedAt:Date.now()}})})},...B(h),...R(h),...z(h,C)}}const F=X();export{F as projectStore};
